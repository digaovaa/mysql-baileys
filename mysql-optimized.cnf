# Configurações MySQL Otimizadas para MySQL-Baileys Ultra Performance
# Adicione essas configurações no seu arquivo my.cnf ou my.ini

[mysqld]
# === CONFIGURAÇÕES DE PERFORMANCE PARA 400+ CONEXÕES ===

# Buffer Pool - Crucial para cache em memória (ajustar conforme RAM disponível)
innodb_buffer_pool_size = 256M              # Mínimo recomendado, pode aumentar para 512M ou 1G
innodb_buffer_pool_instances = 4             # Múltiplas instâncias para melhor concorrência

# Log Files - Otimização de escrita
innodb_log_file_size = 64M                  # Reduz overhead de I/O
innodb_log_buffer_size = 16M                # Buffer para operações de log
innodb_flush_log_at_trx_commit = 2          # Performance vs durabilidade (2 = melhor performance)

# Doublewrite Buffer - Desabilitar para melhor performance (cuidado em produção)
innodb_doublewrite = 0                      # Reduz I/O, mas menos segurança

# Flush Method - Otimização de I/O
innodb_flush_method = O_DIRECT              # Evita double buffering no SO

# Conexões e Threads
max_connections = 500                       # Suportar 400+ conexões + overhead
thread_cache_size = 50                      # Cache de threads para reuso
table_open_cache = 2000                     # Cache de tabelas abertas

# Query Cache - Essencial para queries repetitivas
query_cache_type = ON                       # Ativar cache de queries
query_cache_size = 64M                      # Tamanho do cache (ajustar conforme necessário)
query_cache_limit = 2M                      # Máximo por query individual

# Timeouts - Evitar conexões ociosas
wait_timeout = 600                          # 10 minutos para conexões inativas
interactive_timeout = 600                   # 10 minutos para conexões interativas

# Configurações de Tabela
tmp_table_size = 32M                        # Tabelas temporárias em memória
max_heap_table_size = 32M                   # Tamanho máximo de tabelas HEAP

# Configurações de MyISAM (caso ainda use tabelas MyISAM)
key_buffer_size = 128M                      # Buffer para índices MyISAM

# Configurações de Rede
max_allowed_packet = 64M                    # Pacotes grandes (para BLOBs de session)
net_buffer_length = 32K                     # Buffer de rede

# === CONFIGURAÇÕES ESPECÍFICAS PARA ALTA CONCORRÊNCIA ===

# InnoDB Concorrência
innodb_thread_concurrency = 0              # Auto-detectar (recomendado)
innodb_read_io_threads = 8                 # Threads para leitura
innodb_write_io_threads = 8                # Threads para escrita

# Lock Timeouts
innodb_lock_wait_timeout = 10              # Timeout para locks em segundos
lock_wait_timeout = 10                     # Timeout geral para locks

# Configurações de Compressão (para as tabelas comprimidas)
innodb_compression_level = 6               # Nível de compressão (1-9)
innodb_compression_failure_threshold_pct = 5
innodb_compression_pad_pct_max = 50

# === CONFIGURAÇÕES DE MONITORAMENTO ===

# Logs de Performance
slow_query_log = ON                        # Log de queries lentas
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 1                        # Queries > 1 segundo são logadas

# Performance Schema (para monitoramento avançado)
performance_schema = ON
performance_schema_max_table_instances = 2000

# === CONFIGURAÇÕES DE SEGURANÇA E ESTABILIDADE ===

# Configurações de SQL Mode (mais permissivo para performance)
sql_mode = ""                              # Modo mais permissivo

# Configurações de Character Set
character_set_server = utf8mb4            # Suporte completo a emojis
collation_server = utf8mb4_unicode_ci     # Collation Unicode

# === CONFIGURAÇÕES OPCIONAIS PARA MÁXIMA PERFORMANCE ===
# ATENÇÃO: Use apenas se entender os riscos!

# Sync Binlog (se não usar replicação)
# sync_binlog = 0                          # Melhor performance, menor durabilidade

# Fsync (cuidado em produção!)
# innodb_flush_method = O_DIRECT_NO_FSYNC  # Máxima performance, risco de corrupção

# Adaptive Hash Index
innodb_adaptive_hash_index = ON           # Índices adaptativos para melhor performance

# === EXEMPLO DE STARTUP SCRIPT ===
# Para aplicar otimizações via SQL (execute após iniciar MySQL):
#
# SET GLOBAL innodb_buffer_pool_size = 268435456;  -- 256MB
# SET GLOBAL query_cache_size = 67108864;          -- 64MB  
# SET GLOBAL max_connections = 500;
# FLUSH PRIVILEGES;

# === MONITORAMENTO ===
# Comandos úteis para monitorar performance:
#
# SHOW STATUS LIKE 'Threads_connected';
# SHOW STATUS LIKE 'Innodb_buffer_pool%';
# SHOW STATUS LIKE 'Qcache%';
# SHOW PROCESSLIST;
# SHOW ENGINE INNODB STATUS;
